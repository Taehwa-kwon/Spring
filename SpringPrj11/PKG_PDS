CREATE OR REPLACE 
PACKAGE PKG_PDS AS 

  PROCEDURE PROC_PDS_INSERT (
  IN_MENU_ID IN VARCHAR2,
  IN_TITLE IN VARCHAR2,
  IN_CONT IN VARCHAR2,
  IN_WRITER  IN VARCHAR2,
  IN_BNUM IN NUMBER,
  IN_LVL IN NUMBER,
  IN_STEP IN NUMBER,
  IN_NREF IN NUMBER,
 
   
  IN_FILENAMES IN FILE_ARRAY,
  IN_FILEEXTS IN FILE_ARRAY,
  IN_SFILENAMES IN FILE_ARRAY
  

  );

END PKG_PDS;

================================================================================


CREATE OR REPLACE

PACKAGE BODY PKG_PDS AS

  PROCEDURE PROC_PDS_INSERT (
  IN_MENU_ID IN VARCHAR2,
  IN_TITLE IN VARCHAR2,
  IN_CONT IN VARCHAR2,
  IN_WRITER  IN VARCHAR2,
  IN_BNUM IN NUMBER,
  IN_LVL IN NUMBER,
  IN_STEP IN NUMBER,
  IN_NREF IN NUMBER,

  IN_FILENAMES IN FILE_ARRAY,
  IN_FILEEXTS IN FILE_ARRAY,
  IN_SFILENAMES IN FILE_ARRAY
  
  ) AS
    V_BNUM NUMBER(5,0);
    V_LVL NUMBER(5,0);
    V_STEP NUMBER(5,0);
    V_NREF NUMBER(5,0);
    
    V_MAXIDX NUMBER(5,0);
  
  BEGIN
    IF IN_BNUM =0 THEN --새글처리
    SELECT NVL(MAX(BNUM),0)+1 INTO V_BNUM FROM BOARD WHERE MENU_ID = IN_MENU_ID;
    V_LVL := 0;
    V_STEP := 0;
    SELECT NVL(MAX(NREF),0)+1 INTO V_NREF FROM BOARD WHERE MENU_ID = IN_MENU_ID;
    
    
    ELSE --답글 처리 (즉 IN_BNUM이 0이 아닌것들)
      V_BNUM := IN_BNUM;
      V_LVL := IN_LVL +1;
      V_STEP := IN_STEP +1;
      V_NREF := IN_NREF;
      
      --기존 답글에 대한 순서 +1  
      UPDATE BOARD
        SET STEP = STEP+1
        WHERE MENU_ID = IN_MENU_ID
        AND NREF = IN_NREF
        AND STEP > IN_STEP  --내 댓글보다 큰것 
    ;
    END IF;
    
    --게시글 처리
    INSERT INTO BOARD 
    ( IDX,MENU_ID, TITLE , CONT, WRITER, REGDATE, READCOUNT, BNUM, LVL, STEP, NREF )
    VALUES 
    ( BRDSEQ.NEXTVAL, IN_MENU_ID, IN_TITLE, IN_CONT, IN_WRITER, TO_CHAR(SYSDATE ,'YYYY-MM-DD'),0, V_BNUM, V_LVL, V_STEP, V_NREF )
    ;
    
    --가장 마지막에 추가된 글의 IDX를 V_MAXIDX에 넣어둔다.
    SELECT MAX(IDX) INTO V_MAXIDX FROM BOARD; 
    
    --FILES 처리
       IF IN_FILENAMES(1) IS NOT NULL THEN 
        FOR I IN IN_FILENAMES.FIRST .. IN_FILENAMES.LAST
        LOOP
             INSERT INTO FILES
            VALUES
            (
                (SELECT NVL(MAX(FILE_NUM), 0) + 1 FROM FILES), V_MAXIDX, IN_FILENAMES(I), IN_FILEEXTS(I), IN_SFILENAMES(I)
            );
        END LOOP;
    
    END IF;

    
    --FILES 처리
  END PROC_PDS_INSERT;

END PKG_PDS;